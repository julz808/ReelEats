{
  "project_title": "Facility Nurse and GP Assignment Extraction",
  "objective": "Extract a simple report showing which Nurses and GPs are assigned to each facility, including counts and names",

  "database_credentials": {
    "host": "35.189.18.41",
    "port": 5432,
    "database": "postgres",
    "username": "julian_ou",
    "password": "tkgc.4ieQCwKhj_MWQmjwoXrqDbdEsT.vr8wQQkLx*wUa6CbQh!s",
    "sslmode": "prefer",
    "connect_timeout": 30
  },

  "prompt": "I need you to connect to the PostgreSQL database using the credentials provided above and extract a simple report showing which Nurses and GPs are assigned to each facility.\n\n## What I Need:\n\nFor each facility (care home), I need:\n1. **Facility Name**\n2. **Number of Nurses** assigned to that facility (traditional Nurses only, NOT Nurse Practitioners)\n3. **Names of all Nurses** assigned (comma-separated list)\n4. **Number of GPs** assigned to that facility\n5. **Names of all GPs** assigned (comma-separated list)\n\n## Important Notes:\n\n- **Nurses** means traditional nurses only - NOT Nurse Practitioners\n- Use TWO data sources to find assignments:\n  1. The `facility_practitioner` table (explicit permanent assignments)\n  2. The `rounds` table (practitioners who have worked or are scheduled at facilities)\n- A practitioner is assigned to a facility if they appear in EITHER source\n- Combine both sources using UNION logic (no duplicates)\n- Only include active practitioners (is_deactivated = FALSE or NULL)\n- Only include active facilities (is_deactivated = FALSE or NULL)\n\n## Database Tables You'll Need:\n\n### 1. facilities\n- Contains all care homes\n- Columns: `id`, `name`, `is_deactivated`\n- Filter: `is_deactivated = FALSE OR is_deactivated IS NULL`\n\n### 2. users  \n- Contains all staff including nurses and doctors\n- Columns: `id`, `given_name`, `family_name`, `practitioner_type_id`, `is_deactivated`\n- Filter: `practitioner_type_id IS NOT NULL AND (is_deactivated = FALSE OR is_deactivated IS NULL)`\n\n### 3. practitioner_types\n- Defines practitioner roles (GP, Nurse, etc.)\n- Columns: `id`, `name`\n- Key values: \n  - `name = 'Nurse'` (for nurses)\n  - `name = 'GP'` (for GPs)\n  - `name = 'Nurse Practitioner'` (EXCLUDE these)\n\n### 4. facility_practitioner\n- Junction table linking facilities to practitioners (many-to-many)\n- Columns: `facilities_id`, `practitioners_id`\n- No filters needed - get all mappings\n\n### 5. rounds\n- Booking/scheduling table showing who works where\n- Columns: `facility_id`, `practitioner_id`, `nurse_id`\n- For nurses: use `rounds.nurse_id`\n- For GPs: use `rounds.practitioner_id` (where user has practitioner_type = 'GP')\n\n## Step-by-Step Implementation:\n\n### Step 1: Extract Base Data\nRun these SQL queries:\n\n```sql\n-- Get all active facilities\nSELECT id, name \nFROM facilities \nWHERE is_deactivated = FALSE OR is_deactivated IS NULL;\n\n-- Get all active practitioners\nSELECT id, given_name, family_name, practitioner_type_id\nFROM users\nWHERE practitioner_type_id IS NOT NULL \nAND (is_deactivated = FALSE OR is_deactivated IS NULL);\n\n-- Get practitioner types\nSELECT id, name\nFROM practitioner_types;\n\n-- Get explicit facility-practitioner mappings\nSELECT facilities_id, practitioners_id\nFROM facility_practitioner;\n\n-- Get rounds data (historical and future bookings)\nSELECT DISTINCT facility_id, practitioner_id, nurse_id\nFROM rounds;\n```\n\n### Step 2: Identify Nurses\n1. Find the practitioner_type_id for 'Nurse' (NOT 'Nurse Practitioner')\n2. Get all users with that practitioner_type_id\n3. For each facility:\n   - Get nurses from `facility_practitioner` where `facilities_id` = facility_id\n   - Get nurses from `rounds` where `facility_id` = facility_id (use `nurse_id` column)\n   - Combine both lists (UNION - no duplicates)\n   - Filter to only nurses (not nurse practitioners)\n\n### Step 3: Identify GPs\n1. Find the practitioner_type_id for 'GP'\n2. Get all users with that practitioner_type_id  \n3. For each facility:\n   - Get GPs from `facility_practitioner` where `facilities_id` = facility_id\n   - Get GPs from `rounds` where `facility_id` = facility_id (use `practitioner_id` column)\n   - Combine both lists (UNION - no duplicates)\n   - Filter to only GPs\n\n### Step 4: Generate Output\nCreate an Excel file with these columns:\n- **Facility Name** (e.g., \"Sunset Care Home\")\n- **Nurse Count** (e.g., 5)\n- **Nurse Names** (e.g., \"Jane Smith, John Doe, Mary Johnson, Bob Lee, Alice Wong\")\n- **GP Count** (e.g., 3)\n- **GP Names** (e.g., \"Dr. Sarah Brown, Dr. Michael Chen, Dr. Emily Davis\")\n\n## Expected Output Format:\n\n| Facility Name | Nurse Count | Nurse Names | GP Count | GP Names |\n|---------------|-------------|-------------|----------|----------|\n| Sunset Care Home | 5 | Jane Smith, John Doe, Mary Johnson, Bob Lee, Alice Wong | 3 | Dr. Sarah Brown, Dr. Michael Chen, Dr. Emily Davis |\n| Greenfield Manor | 3 | Lisa White, Tom Black, Susan Green | 2 | Dr. James Wilson, Dr. Anna Martinez |\n| Riverside Lodge | 4 | Chris Blue, Pat Yellow, Sam Red, Jordan Orange | 1 | Dr. David Thompson |\n\n## Output File:\n- Save as Excel file named: `facility_nurse_gp_assignments_[DATE].xlsx`\n- Use pandas + openpyxl or xlsxwriter\n- Format: Clean table with headers, no extra styling needed\n\n## Key Logic:\n\n```python\n# Pseudocode for combining sources\nfor each facility:\n    # For Nurses\n    nurses_from_mapping = get practitioners from facility_practitioner\n    nurses_from_rounds = get nurse_id values from rounds for this facility\n    all_nurses = list(set(nurses_from_mapping + nurses_from_rounds))  # Union\n    filter to only practitioner_type = 'Nurse' (not Nurse Practitioner)\n    \n    # For GPs  \n    gps_from_mapping = get practitioners from facility_practitioner\n    gps_from_rounds = get practitioner_id values from rounds for this facility\n    all_gps = list(set(gps_from_mapping + gps_from_rounds))  # Union\n    filter to only practitioner_type = 'GP'\n```\n\n## Important Filtering:\n\n**For Nurses:**\n- practitioner_types.name = 'Nurse'\n- practitioner_types.name DOES NOT contain 'Practitioner'\n- If the database has entries like 'Nurse', use exact match OR use pattern matching to exclude 'Nurse Practitioner'\n\n**For GPs:**\n- practitioner_types.name = 'GP' (exact match)\n- This should capture entries like 'GP' but not 'GP - Telehealth' or 'GP Telehealth Region Cover'\n- If you want to include all GP variants, use: practitioner_types.name LIKE '%GP%' OR practitioner_types.name LIKE 'GP%'\n\n## Error Handling:\n\n- If a facility has no nurses: show 0 for count, blank for names\n- If a facility has no GPs: show 0 for count, blank for names  \n- If a practitioner name is missing: use 'Unknown' or their ID\n- Handle NULL values gracefully\n\n## Deliverables:\n\n1. Python script that performs the extraction\n2. Excel file with the results\n3. Brief summary showing:\n   - Total number of facilities processed\n   - Total number of unique nurses found\n   - Total number of unique GPs found\n   - Any facilities with 0 nurses or 0 GPs (flag for attention)\n\nPlease start by connecting to the database, exploring the schema to confirm the table structures, then implement the extraction logic as described above.",

  "quick_reference": {
    "key_tables": ["facilities", "users", "practitioner_types", "facility_practitioner", "rounds"],
    "key_joins": [
      "users.practitioner_type_id = practitioner_types.id",
      "facility_practitioner.practitioners_id = users.id",
      "facility_practitioner.facilities_id = facilities.id",
      "rounds.nurse_id = users.id (for nurses)",
      "rounds.practitioner_id = users.id (for GPs)",
      "rounds.facility_id = facilities.id"
    ],
    "target_practitioner_types": ["Nurse", "GP"],
    "exclude_practitioner_types": ["Nurse Practitioner"],
    "dual_source_logic": "UNION of facility_practitioner + rounds"
  },

  "simplified_sql_approach": {
    "description": "If you want a simpler approach using just SQL queries, here's a consolidated query approach:",
    "nurses_query": "-- Get all nurses assigned to each facility (from both sources)\nSELECT \n    f.id AS facility_id,\n    f.name AS facility_name,\n    u.id AS nurse_id,\n    CONCAT(u.given_name, ' ', u.family_name) AS nurse_name\nFROM facilities f\nLEFT JOIN (\n    -- Source 1: facility_practitioner mapping\n    SELECT fp.facilities_id, fp.practitioners_id\n    FROM facility_practitioner fp\n    UNION\n    -- Source 2: rounds nurse_id\n    SELECT DISTINCT r.facility_id, r.nurse_id AS practitioners_id\n    FROM rounds r\n    WHERE r.nurse_id IS NOT NULL\n) AS combined_mappings ON f.id = combined_mappings.facilities_id\nLEFT JOIN users u ON combined_mappings.practitioners_id = u.id\nLEFT JOIN practitioner_types pt ON u.practitioner_type_id = pt.id\nWHERE (f.is_deactivated = FALSE OR f.is_deactivated IS NULL)\nAND pt.name = 'Nurse'\nAND (u.is_deactivated = FALSE OR u.is_deactivated IS NULL)\nORDER BY f.name, nurse_name;",

    "gps_query": "-- Get all GPs assigned to each facility (from both sources)\nSELECT \n    f.id AS facility_id,\n    f.name AS facility_name,\n    u.id AS gp_id,\n    CONCAT(u.given_name, ' ', u.family_name) AS gp_name\nFROM facilities f\nLEFT JOIN (\n    -- Source 1: facility_practitioner mapping\n    SELECT fp.facilities_id, fp.practitioners_id\n    FROM facility_practitioner fp\n    UNION\n    -- Source 2: rounds practitioner_id  \n    SELECT DISTINCT r.facility_id, r.practitioner_id AS practitioners_id\n    FROM rounds r\n    WHERE r.practitioner_id IS NOT NULL\n) AS combined_mappings ON f.id = combined_mappings.facilities_id\nLEFT JOIN users u ON combined_mappings.practitioners_id = u.id\nLEFT JOIN practitioner_types pt ON u.practitioner_type_id = pt.id\nWHERE (f.is_deactivated = FALSE OR f.is_deactivated IS NULL)\nAND pt.name = 'GP'\nAND (u.is_deactivated = FALSE OR u.is_deactivated IS NULL)\nORDER BY f.name, gp_name;",

    "note": "These queries return one row per facility-practitioner pair. You'll need to group by facility in Python to create the final aggregated report."
  }
}
